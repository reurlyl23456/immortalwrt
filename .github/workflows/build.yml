name: Build AX3000 firmware

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
    steps:
      - name: Checkout AX3000 repo
        uses: actions/checkout@v4
        with:
          repository: hzyitc/openwrt-redmi-ax3000
          ref: main

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-distutils rsync unzip zlib1g-dev file wget curl ccache

      - name: Update feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Use custom .config
        run: |
          cp ${{ github.workspace }}/.config .config
          make defconfig

      - name: Build firmware
        run: |
          make -j$(nproc) || make -j1 V=s

      - name: Find AX3000 factory.ubi
        id: find
        run: |
          FILE=$(find bin/targets/ -type f -name '*redmi-ax3000*squashfs-factory.ubi' | head -n 1)
          if [ -z "$FILE" ]; then
            echo "❌ No AX3000 squashfs-factory.ubi firmware found!"
            echo "ℹ️  Available files:" 
            find bin/targets/ -type f
            exit 1
          fi
          echo "✅ Found firmware: $FILE"
          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Upload AX3000 firmware
        uses: actions/upload-artifact@v4
        with:
          name: ax3000-factory-ubi
          path: ${{ steps.find.outputs.file }}
          retention-days: 14
