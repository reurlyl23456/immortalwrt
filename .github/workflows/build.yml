name: Build ImmortalWrt for AX3000

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Show current directory
        run: pwd

      - name: Generate .config for AX3000
        run: |
          cat > .config <<'EOF'
# ç›®æ ‡è®¾å¤‡ï¼šçº¢ç±³ AX3000
CONFIG_TARGET_ipq50xx=y
CONFIG_TARGET_ipq50xx_DEVICE_redmi_ax3000=y

# LuCI ç•Œé¢
CONFIG_PACKAGE_luci=y
CONFIG_LUCI_LANG_zh_Hans=y
CONFIG_PACKAGE_luci-ssl=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

# PassWall ä¸»ä½“åŠä¾èµ–
CONFIG_PACKAGE_luci-app-passwall=y
CONFIG_PACKAGE_passwall=y
CONFIG_PACKAGE_ipset=y
CONFIG_PACKAGE_ip-full=y
CONFIG_PACKAGE_iptables-mod-tproxy=y
CONFIG_PACKAGE_kmod-ipt-nat6=y

# åè®®æ”¯æŒ
CONFIG_PACKAGE_xray-core=y
CONFIG_PACKAGE_trojan-plus=y
CONFIG_PACKAGE_hysteria=y
# CONFIG_PACKAGE_shadowsocks-libev-ss-local=y
# CONFIG_PACKAGE_shadowsocksr-libev-ssr-local=y

# DNS æ”¯æŒ
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_luci-app-dnsforwarder=y
CONFIG_PACKAGE_luci-app-smartdns=y

# å¸¸ç”¨ç½‘ç»œå·¥å…·
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_wget=y
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_tcpdump=y
CONFIG_PACKAGE_nmap=y

# å†…æ ¸åŠå›ºä»¶ä¼˜åŒ–
CONFIG_TARGET_KERNEL_COMPRESS_XZ=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_UBI_IMAGES=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_IMAGES_PAD=y
CONFIG_TARGET_KERNEL_PARTSIZE=64
CONFIG_TARGET_ROOTFS_PARTSIZE=256

# Overlay æ‰©å±•æ”¯æŒ
CONFIG_TARGET_ROOTFS_EXT4=y

# ç§»é™¤ä¸å¿…è¦çš„åŒ…ï¼ŒèŠ‚çœç©ºé—´
# CONFIG_PACKAGE_luci-theme-argon is not set

# ç³»ç»ŸåŠŸèƒ½å¢žå¼º
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_kmod-nls-cp437=y
CONFIG_PACKAGE_kmod-nls-utf8=y
CONFIG_PACKAGE_kmod-fs-exfat=y
CONFIG_PACKAGE_kmod-fs-ntfs=y
CONFIG_PACKAGE_parted=y

# ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œé˜²æ­¢å®‰è£…è½¯ä»¶å¤±è´¥
CONFIG_BUSYBOX_CUSTOM=y
CONFIG_BUSYBOX_DEFAULT_FEATURES=y
CONFIG_BUSYBOX_CONFIG_FEATURE_WGET=y
EOF
          echo "âœ… .config å·²ç”Ÿæˆ"

      - name: Compile ImmortalWrt (squashfs-nand-factory only)
        run: |
          make defconfig
          make download -j2
          make -j2 V=s IMAGE_BUILDER_TARGETS="ipq50xx/ax3000:squashfs-nand-factory" || make -j1 V=s IMAGE_BUILDER_TARGETS="ipq50xx/ax3000:squashfs-nand-factory"
        continue-on-error: true

      - name: Show last 100 lines if build failed
        if: failure()
        run: tail -n 100 /home/runner/work/immortalwrt/immortalwrt/build_dir/target-*/log/*.log || echo "No log found"

      - name: Print generated UBI file path
        run: |
          echo "ðŸ”¹ Generated firmware file(s):"
          find bin/targets/ipq50xx/ -type f -name "*.ubi" || echo "æœªæ‰¾åˆ° UBI æ–‡ä»¶"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-ax3000
          path: bin/targets/ipq50xx/
          retention-days: 14
