name: Build ImmortalWrt for AX3000

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1️⃣ 检出 ImmortalWrt 仓库
      - name: Checkout ImmortalWrt
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: openwrt-23.05

      # 2️⃣ 更新 feeds
      - name: Update feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 3️⃣ Debug 查看 .config 是否存在
      - name: Debug check .config
        run: |
          echo "Current directory: $(pwd)"
          ls -al
          if [ -f ".config" ]; then
              echo "✅ .config 文件存在"
          else
              echo "❌ .config 文件不存在"
          fi

      # 4️⃣ 加载自定义 .config（使用相对路径）
      - name: Load custom config
        run: |
          if [ -f ".config" ]; then
              cp ".config" .config
              echo "✅ Using custom .config"
          else
              echo "⚠️ No .config found, using default"
          fi

      # 5️⃣ 编译固件
      - name: Compile firmware
        run: |
          make defconfig
          make download -j8
          make -j$(nproc) || make -j1 V=s

      # 6️⃣ 收集 redmi_ax3000 squashfs-nand-factory.ubi
      - name: Collect AX3000 firmware
        run: |
          mkdir -p output_ubi output_bin
          BUILD_DATE=$(date +%Y-%m-%d)

          # 只收集 factory UBI 文件
          for f in bin/targets/ipq50xx/aarch64_cortex-a53/*redmi_ax3000*squashfs-nand-factory.ubi; do
              [ -e "$f" ] || continue
              base=$(basename "$f")
              cp -v "$f" "output_ubi/immortalwrt-ax3000-${BUILD_DATE}-${base#*redmi_ax3000-}"
          done

          # 收集其他 BIN 文件
          for f in bin/targets/ipq50xx/aarch64_cortex-a53/*; do
              [ -e "$f" ] || continue
              if [[ "$f" != *.ubi ]]; then
                  base=$(basename "$f")
                  cp -v "$f" "output_bin/immortalwrt-ax3000-${BUILD_DATE}-${base}"
              fi
          done

          echo "✅ 收集完成："
          ls -lh output_ubi || echo "⚠️ 没有生成 factory UBI 文件"
          ls -lh output_bin || echo "⚠️ 没有 BIN 文件"

      # 7️⃣ 上传 factory UBI 固件
      - name: Upload UBI factory firmware
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-ax3000-ubi-factory
          path: output_ubi/
          retention-days: 14

      # 8️⃣ 上传其他 BIN 文件
      - name: Upload BIN firmware
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-ax3000-bin
          path: output_bin/
          retention-days: 14
